# 인증 전략

Claustrum은 MCP 클라이언트 및 관리/API 작업에 대해 단계별 인증 모델을 사용합니다.

## 1단계(현재): API 키

- 인증 방법: 사용자별 API 키(`Authorization: Bearer <api_key>`).
- 주요 수명주기:
  - 한 번 생성되고 한 번 표시됩니다.
  - 취소 가능,
  - 일회성 링크를 통한 관리자 재설정.
- 서버 스토리지:
  - DB에 일반 텍스트 키가 없습니다.
  - `key_hash`만,
  - 안전한 전시를 위해 `key_prefix`,
  - `device_label` 필수,
  - 선택사항 `expires_at`.
- 범위:
  - API 키는 작업공간 범위(`workspace_id`)입니다.
  - 범위가 지정된 키에 대해서는 작업공간 간 액세스가 거부됩니다.
- 로컬 MCP 어댑터 저장소:
  - `~/.claustrum/state.json`,
  - 쓰기 시 `chmod 600` 시행,
  - 파일이 너무 허용적인 경우 경고 + 자동 강화.
- 보안 행동:
  - 키/토큰 로깅이 없습니다.
  - 디버그/오류 출력에 마스크된 헤더 및 비밀,
  - 게이트웨이에서 401/403이 재로그인 안내를 반환합니다.
- 감사 이벤트:
  - `api_key.created`
  - `api_key.revoked`
  - `api_key.reset`
  - `api_key.one_time_view`

## 1단계 장점

- 빠른 온보딩과 간단한 조작.
- 로컬 및 원격 MCP 어댑터 배포 전반에 걸쳐 작동합니다.
- CLI 사용을 위해 외부 ID 공급자에 의존하지 않습니다.

## 1단계 제한 사항

- 로컬 파일 일반 텍스트 저장소(1단계용으로 의도됨).
- `expires_at`이 구성되지 않은 경우 수명이 긴 키 모델입니다.

## 2단계(예정): 장치 흐름 + 키체인

- 대화형 로그인을 위한 OAuth 장치 흐름.
- 단기 액세스 토큰 + 순환 새로 고침 토큰.
- OS 키체인에 저장된 새로 고침 토큰(일반 텍스트 파일 아님)
- 장치 수준 취소 및 세션 수명주기 제어.
- 이전 버전과의 호환성:
  - 기존 API 키 사용자는 계속해서 작업하며,
  - 장치 흐름이 새 로그인에 대한 기본 경로가 됩니다.

## 마이그레이션 경로

1. API 키 엔드포인트와 감사 동작을 안정적으로 유지합니다.
2. 장치 흐름 끝점 및 토큰 교환을 추가합니다.
3. 어댑터 자격 증명 공급자 추상화를 도입합니다.
4. `state.json` API 키에서 키체인 지원 새로 고침 토큰으로 이동합니다.
5. 제어된 호환성 창을 위해 대체 API 키 모드를 유지합니다.