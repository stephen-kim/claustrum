generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
}

enum ProjectRole {
  ADMIN
  MEMBER
}

enum ResolutionKind {
  github_remote
  repo_root_slug
  manual
}

enum MonorepoMode {
  repo_only
  repo_hash_subpath
  repo_colon_subpath
}

enum ImportSource {
  codex
  claude
  generic
}

enum ImportStatus {
  uploaded
  parsed
  extracted
  committed
  failed
}

enum MemoryStatus {
  draft
  confirmed
  rejected
}

enum MemorySource {
  auto
  human
  import
}

enum RawEventType {
  post_commit
  post_merge
  post_checkout
}

enum AutoExtractionMode {
  draft_only
  auto_confirm
}

enum SearchDefaultMode {
  hybrid
  keyword
  semantic
}

enum IntegrationProvider {
  notion
  jira
  confluence
  linear
  slack
  audit_reasoner
}

model Workspace {
  id                String             @id @default(cuid())
  key               String             @unique
  name              String
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  members           WorkspaceMember[]
  projects          Project[]
  memories          Memory[]
  settings          WorkspaceSettings?
  projectMappings   ProjectMapping[]
  imports           ImportRecord[]
  rawSessions       RawSession[]
  rawEvents         RawEvent[]
  auditLogs         AuditLog[]
  stagedMemories    StagedMemory[]
  integrations      WorkspaceIntegration[]

  @@map("workspaces")
}

model User {
  id                String            @id @default(cuid())
  email             String            @unique
  name              String?
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  workspaceMembers  WorkspaceMember[]
  projectMembers    ProjectMember[]
  apiKeys           ApiKey[]

  @@map("users")
}

model WorkspaceMember {
  id          String        @id @default(cuid())
  workspaceId String        @map("workspace_id")
  userId      String        @map("user_id")
  role        WorkspaceRole @default(MEMBER)
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
  workspace   Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([workspaceId, role])
  @@map("workspace_members")
}

model Project {
  id          String          @id @default(cuid())
  workspaceId String          @map("workspace_id")
  key         String
  name        String
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")
  workspace   Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  members     ProjectMember[]
  memories    Memory[]
  mappings    ProjectMapping[]
  rawSessions RawSession[]
  rawEvents   RawEvent[]
  stagedMemories StagedMemory[]

  @@unique([workspaceId, key])
  @@index([workspaceId, key])
  @@map("projects")
}

model ProjectMember {
  id        String      @id @default(cuid())
  projectId String      @map("project_id")
  userId    String      @map("user_id")
  role      ProjectRole @default(MEMBER)
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@map("project_members")
}

model Memory {
  id          String    @id @default(cuid())
  workspaceId String    @map("workspace_id")
  projectId   String    @map("project_id")
  type        String
  content     String
  status      MemoryStatus @default(draft)
  source      MemorySource @default(auto)
  confidence  Float     @default(0.0)
  evidence    Json?
  metadata    Json?
  embedding   Unsupported("vector")?
  contentTsv  Unsupported("tsvector")? @map("content_tsv")
  createdBy   String    @map("created_by")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, type, createdAt(sort: Desc)])
  @@index([projectId, createdAt(sort: Desc)])
  @@index([workspaceId, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@map("memories")
}

model WorkspaceSettings {
  workspaceId                   String       @id @map("workspace_id")
  resolutionOrder               Json         @default(dbgenerated("'[\"github_remote\", \"repo_root_slug\", \"manual\"]'::jsonb")) @map("resolution_order")
  autoCreateProject             Boolean      @default(true) @map("auto_create_project")
  autoCreateProjectSubprojects  Boolean      @default(true) @map("auto_create_project_subprojects")
  autoSwitchRepo                Boolean      @default(true) @map("auto_switch_repo")
  autoSwitchSubproject          Boolean      @default(false) @map("auto_switch_subproject")
  allowManualPin                Boolean      @default(true) @map("allow_manual_pin")
  enableGitEvents               Boolean      @default(true) @map("enable_git_events")
  enableCommitEvents            Boolean      @default(true) @map("enable_commit_events")
  enableMergeEvents             Boolean      @default(true) @map("enable_merge_events")
  enableCheckoutEvents          Boolean      @default(false) @map("enable_checkout_events")
  checkoutDebounceSeconds       Int          @default(30) @map("checkout_debounce_seconds")
  checkoutDailyLimit            Int          @default(200) @map("checkout_daily_limit")
  enableAutoExtraction          Boolean      @default(true) @map("enable_auto_extraction")
  autoExtractionMode            AutoExtractionMode @default(draft_only) @map("auto_extraction_mode")
  autoConfirmMinConfidence      Float        @default(0.85) @map("auto_confirm_min_confidence")
  autoConfirmAllowedEventTypes  Json         @default(dbgenerated("'[\"post_commit\", \"post_merge\"]'::jsonb")) @map("auto_confirm_allowed_event_types")
  autoConfirmKeywordAllowlist   Json         @default(dbgenerated("'[\"migrate\", \"switch\", \"remove\", \"deprecate\", \"rename\", \"refactor\"]'::jsonb")) @map("auto_confirm_keyword_allowlist")
  autoConfirmKeywordDenylist    Json         @default(dbgenerated("'[\"wip\", \"tmp\", \"debug\", \"test\", \"try\"]'::jsonb")) @map("auto_confirm_keyword_denylist")
  autoExtractionBatchSize       Int          @default(20) @map("auto_extraction_batch_size")
  searchDefaultMode             SearchDefaultMode @default(hybrid) @map("search_default_mode")
  searchHybridAlpha             Float        @default(0.6) @map("search_hybrid_alpha")
  searchHybridBeta              Float        @default(0.4) @map("search_hybrid_beta")
  searchDefaultLimit            Int          @default(20) @map("search_default_limit")
  githubKeyPrefix               String       @default("github:") @map("auto_create_key_prefix")
  localKeyPrefix                String       @default("local:") @map("auto_create_local_key_prefix")
  enableMonorepoResolution      Boolean      @default(false) @map("enable_monorepo_resolution")
  monorepoDetectionLevel        Int          @default(2) @map("monorepo_detection_level")
  monorepoMode                  MonorepoMode @default(repo_hash_subpath) @map("monorepo_mode")
  monorepoRootMarkers           Json         @default(dbgenerated("'[\"pnpm-workspace.yaml\", \"turbo.json\", \"nx.json\", \"lerna.json\"]'::jsonb")) @map("monorepo_root_markers")
  monorepoWorkspaceGlobs        Json         @default(dbgenerated("'[\"apps/*\", \"packages/*\"]'::jsonb")) @map("monorepo_workspace_globs")
  monorepoExcludeGlobs          Json         @default(dbgenerated("'[\"**/node_modules/**\", \"**/.git/**\", \"**/dist/**\", \"**/build/**\", \".next/**\"]'::jsonb")) @map("monorepo_exclude_globs")
  monorepoMaxDepth              Int          @default(3) @map("monorepo_max_depth")
  createdAt                     DateTime     @default(now()) @map("created_at")
  updatedAt                     DateTime     @updatedAt @map("updated_at")
  workspace                     Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@map("workspace_settings")
}

model ProjectMapping {
  id         String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workspaceId String        @map("workspace_id")
  projectId   String        @map("project_id")
  kind       ResolutionKind
  externalId String         @map("external_id")
  priority   Int
  isEnabled  Boolean        @default(true) @map("is_enabled")
  createdAt  DateTime       @default(now()) @map("created_at")
  updatedAt  DateTime       @updatedAt @map("updated_at")
  workspace  Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project    Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, kind, externalId])
  @@index([workspaceId, kind, priority, isEnabled])
  @@map("project_mappings")
}

model ApiKey {
  id        String   @id @default(cuid())
  key       String   @unique
  label     String?
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("api_keys")
}

model ImportRecord {
  id         String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workspaceId String      @map("workspace_id")
  createdBy  String       @map("created_by")
  source     ImportSource
  status     ImportStatus
  fileName   String       @map("file_name")
  filePath   String?      @map("file_path")
  stats      Json?
  error      String?
  createdAt  DateTime     @default(now()) @map("created_at")
  updatedAt  DateTime     @updatedAt @map("updated_at")
  workspace  Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  rawSessions RawSession[]
  stagedMemories StagedMemory[]

  @@index([workspaceId, createdAt(sort: Desc)])
  @@map("imports")
}

model RawSession {
  id              String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workspaceId     String       @map("workspace_id")
  projectId       String?      @map("project_id")
  importId        String?      @map("import_id") @db.Uuid
  source          ImportSource
  sourceSessionId String?      @map("source_session_id")
  title           String?
  startedAt       DateTime?    @map("started_at") @db.Timestamptz(6)
  endedAt         DateTime?    @map("ended_at") @db.Timestamptz(6)
  metadata        Json?
  createdBy       String       @map("created_by")
  createdAt       DateTime     @default(now()) @map("created_at")
  workspace       Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project         Project?     @relation(fields: [projectId], references: [id], onDelete: SetNull)
  import          ImportRecord? @relation(fields: [importId], references: [id], onDelete: SetNull)
  messages        RawMessage[]

  @@unique([workspaceId, source, sourceSessionId])
  @@index([workspaceId, createdAt(sort: Desc)])
  @@index([projectId, createdAt(sort: Desc)])
  @@map("raw_sessions")
}

model RawMessage {
  id           String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  rawSessionId String     @map("raw_session_id") @db.Uuid
  role         String
  content      String
  metadata     Json?
  createdAt    DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  rawSession   RawSession @relation(fields: [rawSessionId], references: [id], onDelete: Cascade)

  @@index([rawSessionId, createdAt(sort: Asc)])
  @@index([createdAt(sort: Desc)])
  @@map("raw_messages")
}

model StagedMemory {
  id         String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  importId   String      @map("import_id") @db.Uuid
  workspaceId String     @map("workspace_id")
  projectId  String?     @map("project_id")
  type       String
  content    String
  metadata   Json?
  isSelected Boolean     @default(true) @map("is_selected")
  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @updatedAt @map("updated_at")
  import     ImportRecord @relation(fields: [importId], references: [id], onDelete: Cascade)
  workspace  Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project    Project?    @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([importId, createdAt(sort: Desc)])
  @@index([workspaceId, createdAt(sort: Desc)])
  @@map("staged_memories")
}

model RawEvent {
  id            String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workspaceId   String       @map("workspace_id")
  projectId     String       @map("project_id")
  eventType     RawEventType @map("event_type")
  repoKey       String       @map("repo_key")
  subprojectKey String?      @map("subproject_key")
  branch        String?
  fromBranch    String?      @map("from_branch")
  toBranch      String?      @map("to_branch")
  commitSha     String?      @map("commit_sha")
  commitMessage String?      @map("commit_message")
  changedFiles  Json?        @map("changed_files")
  metadata      Json?
  createdAt     DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  workspace     Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project       Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, eventType, createdAt(sort: Desc)])
  @@index([workspaceId, createdAt(sort: Desc)])
  @@map("raw_events")
}

model AuditLog {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workspaceId String    @map("workspace_id")
  actorUserId String    @map("actor_user_id")
  action      String
  target      Json
  createdAt   DateTime  @default(now()) @map("created_at")
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId, createdAt(sort: Desc)])
  @@index([action, createdAt(sort: Desc)])
  @@map("audit_logs")
}

model WorkspaceIntegration {
  id          String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workspaceId String              @map("workspace_id")
  provider    IntegrationProvider
  isEnabled   Boolean             @default(true) @map("is_enabled")
  config      Json                @default("{}")
  createdAt   DateTime            @default(now()) @map("created_at")
  updatedAt   DateTime            @updatedAt @map("updated_at")
  workspace   Workspace           @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, provider])
  @@index([workspaceId, provider, isEnabled])
  @@map("workspace_integrations")
}
