generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
}

enum ProjectRole {
  ADMIN
  MEMBER
}

enum ResolutionKind {
  github_remote
  repo_root_slug
  manual
}

enum ImportSource {
  codex
  claude
  generic
}

enum ImportStatus {
  uploaded
  parsed
  extracted
  committed
  failed
}

enum IntegrationProvider {
  notion
  jira
  confluence
  linear
  slack
}

model Workspace {
  id                String             @id @default(cuid())
  key               String             @unique
  name              String
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  members           WorkspaceMember[]
  projects          Project[]
  memories          Memory[]
  settings          WorkspaceSettings?
  projectMappings   ProjectMapping[]
  imports           ImportRecord[]
  rawSessions       RawSession[]
  auditLogs         AuditLog[]
  stagedMemories    StagedMemory[]
  integrations      WorkspaceIntegration[]

  @@map("workspaces")
}

model User {
  id                String            @id @default(cuid())
  email             String            @unique
  name              String?
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  workspaceMembers  WorkspaceMember[]
  projectMembers    ProjectMember[]
  apiKeys           ApiKey[]

  @@map("users")
}

model WorkspaceMember {
  id          String        @id @default(cuid())
  workspaceId String        @map("workspace_id")
  userId      String        @map("user_id")
  role        WorkspaceRole @default(MEMBER)
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
  workspace   Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([workspaceId, role])
  @@map("workspace_members")
}

model Project {
  id          String          @id @default(cuid())
  workspaceId String          @map("workspace_id")
  key         String
  name        String
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")
  workspace   Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  members     ProjectMember[]
  memories    Memory[]
  mappings    ProjectMapping[]
  rawSessions RawSession[]
  stagedMemories StagedMemory[]

  @@unique([workspaceId, key])
  @@index([workspaceId, key])
  @@map("projects")
}

model ProjectMember {
  id        String      @id @default(cuid())
  projectId String      @map("project_id")
  userId    String      @map("user_id")
  role      ProjectRole @default(MEMBER)
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@map("project_members")
}

model Memory {
  id          String    @id @default(cuid())
  workspaceId String    @map("workspace_id")
  projectId   String    @map("project_id")
  type        String
  content     String
  metadata    Json?
  createdBy   String    @map("created_by")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, type, createdAt(sort: Desc)])
  @@index([workspaceId, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@map("memories")
}

model WorkspaceSettings {
  workspaceId        String   @id @map("workspace_id")
  resolutionOrder    Json     @default(dbgenerated("'[\"github_remote\", \"repo_root_slug\", \"manual\"]'::jsonb")) @map("resolution_order")
  autoCreateProject  Boolean  @default(true) @map("auto_create_project")
  githubKeyPrefix    String   @default("github:") @map("auto_create_key_prefix")
  localKeyPrefix     String   @default("local:") @map("auto_create_local_key_prefix")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")
  workspace          Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@map("workspace_settings")
}

model ProjectMapping {
  id         String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workspaceId String        @map("workspace_id")
  projectId   String        @map("project_id")
  kind       ResolutionKind
  externalId String         @map("external_id")
  priority   Int
  isEnabled  Boolean        @default(true) @map("is_enabled")
  createdAt  DateTime       @default(now()) @map("created_at")
  updatedAt  DateTime       @updatedAt @map("updated_at")
  workspace  Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project    Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, kind, externalId])
  @@index([workspaceId, kind, priority, isEnabled])
  @@map("project_mappings")
}

model ApiKey {
  id        String   @id @default(cuid())
  key       String   @unique
  label     String?
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("api_keys")
}

model ImportRecord {
  id         String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workspaceId String      @map("workspace_id")
  createdBy  String       @map("created_by")
  source     ImportSource
  status     ImportStatus
  fileName   String       @map("file_name")
  filePath   String?      @map("file_path")
  stats      Json?
  error      String?
  createdAt  DateTime     @default(now()) @map("created_at")
  updatedAt  DateTime     @updatedAt @map("updated_at")
  workspace  Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  rawSessions RawSession[]
  stagedMemories StagedMemory[]

  @@index([workspaceId, createdAt(sort: Desc)])
  @@map("imports")
}

model RawSession {
  id              String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workspaceId     String       @map("workspace_id")
  projectId       String?      @map("project_id")
  importId        String?      @map("import_id") @db.Uuid
  source          ImportSource
  sourceSessionId String?      @map("source_session_id")
  title           String?
  startedAt       DateTime?    @map("started_at") @db.Timestamptz(6)
  endedAt         DateTime?    @map("ended_at") @db.Timestamptz(6)
  metadata        Json?
  createdBy       String       @map("created_by")
  createdAt       DateTime     @default(now()) @map("created_at")
  workspace       Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project         Project?     @relation(fields: [projectId], references: [id], onDelete: SetNull)
  import          ImportRecord? @relation(fields: [importId], references: [id], onDelete: SetNull)
  messages        RawMessage[]

  @@unique([workspaceId, source, sourceSessionId])
  @@index([workspaceId, createdAt(sort: Desc)])
  @@index([projectId, createdAt(sort: Desc)])
  @@map("raw_sessions")
}

model RawMessage {
  id           String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  rawSessionId String     @map("raw_session_id") @db.Uuid
  role         String
  content      String
  metadata     Json?
  createdAt    DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  rawSession   RawSession @relation(fields: [rawSessionId], references: [id], onDelete: Cascade)

  @@index([rawSessionId, createdAt(sort: Asc)])
  @@index([createdAt(sort: Desc)])
  @@map("raw_messages")
}

model StagedMemory {
  id         String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  importId   String      @map("import_id") @db.Uuid
  workspaceId String     @map("workspace_id")
  projectId  String?     @map("project_id")
  type       String
  content    String
  metadata   Json?
  isSelected Boolean     @default(true) @map("is_selected")
  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @updatedAt @map("updated_at")
  import     ImportRecord @relation(fields: [importId], references: [id], onDelete: Cascade)
  workspace  Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project    Project?    @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([importId, createdAt(sort: Desc)])
  @@index([workspaceId, createdAt(sort: Desc)])
  @@map("staged_memories")
}

model AuditLog {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workspaceId String    @map("workspace_id")
  actorUserId String    @map("actor_user_id")
  action      String
  target      Json
  createdAt   DateTime  @default(now()) @map("created_at")
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId, createdAt(sort: Desc)])
  @@index([action, createdAt(sort: Desc)])
  @@map("audit_logs")
}

model WorkspaceIntegration {
  id          String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workspaceId String              @map("workspace_id")
  provider    IntegrationProvider
  isEnabled   Boolean             @default(true) @map("is_enabled")
  config      Json                @default("{}")
  createdAt   DateTime            @default(now()) @map("created_at")
  updatedAt   DateTime            @updatedAt @map("updated_at")
  workspace   Workspace           @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, provider])
  @@index([workspaceId, provider, isEnabled])
  @@map("workspace_integrations")
}
